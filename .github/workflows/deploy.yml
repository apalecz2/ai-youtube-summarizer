name: Deploy to Debian Mini PC

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install cloudflared
        run: |
          curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null

          echo "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared any main" \
            | sudo tee /etc/apt/sources.list.d/cloudflared.list

          sudo apt-get update
          sudo apt-get install -y cloudflared

      - name: Set up SSH for deploy user
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Write private key
          echo "${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # SSH config with Cloudflare Access + custom port
          cat << 'EOF' > ~/.ssh/config
          Host debianMiniPC
            HostName ssh-v2.aidenpaleczny.com
            User deploy
            Port 1919
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking no
            ProxyCommand cloudflared access ssh --hostname %h --id ${{ secrets.CLOUDFLARE_ACCESS_CLIENT_ID }} --secret ${{ secrets.CLOUDFLARE_ACCESS_CLIENT_SECRET }}
          EOF

          chmod 600 ~/.ssh/config

      - name: Test SSH connection
        run: |
          ssh debianMiniPC "whoami && hostname && docker --version"

      - name: Deploy with Docker Compose
        run: |
          ssh debianMiniPC << 'EOF'
            set -e
            cd ~/docker/ai-youtube-summarizer/youtube-summary-service
            git pull
            docker compose up -d --build
          EOF
